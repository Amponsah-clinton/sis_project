{% extends 'app/base.html' %}
{% load static %}

{% block title %}Create News - ScholarIndex{% endblock %}

{% block content %}
<style>
  .create-news-page {
    padding: 2rem 1.5rem;
    background-color: #f9fafb;
    min-height: calc(100vh - 5rem);
  }

  .create-news-wrapper {
    max-width: 1000px;
    margin: 0 auto;
  }

  .create-news-header {
    margin-bottom: 2rem;
  }

  .create-news-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .create-news-header p {
    font-size: 0.9375rem;
    color: #6b7280;
  }

  .create-news-form {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 2.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
  }

  .form-section {
    margin-bottom: 2rem;
  }

  .form-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #f3f4f6;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .form-group label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }

  .form-group label .required {
    color: #dc2626;
    margin-left: 0.25rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.9375rem;
    color: #111827;
    background-color: #ffffff;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group select[multiple] {
    min-height: 120px;
    padding: 0.5rem;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-hint {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .file-upload-wrapper {
    position: relative;
  }

  .file-upload-label {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background-color: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .file-upload-label:hover {
    background-color: #e5e7eb;
    border-color: #9ca3af;
  }

  .file-upload-input {
    position: absolute;
    width: 0;
    height: 0;
    opacity: 0;
    overflow: hidden;
  }

  .file-name-display {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #059669;
    font-weight: 500;
  }

  .quill-editor-wrapper {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    overflow: hidden;
    background-color: #ffffff;
  }

  .quill-editor-wrapper:focus-within {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .quill-editor-wrapper .ql-toolbar {
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
    padding: 0.5rem;
  }

  .quill-editor-wrapper .ql-container {
    border: none;
    font-size: 0.9375rem;
    min-height: 300px;
  }

  .quill-editor-wrapper .ql-editor {
    min-height: 300px;
    color: #111827;
  }

  .quill-editor-wrapper .ql-editor.ql-blank::before {
    color: #9ca3af;
    font-style: normal;
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background-color: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
  }

  .checkbox-group:hover {
    background-color: #f3f4f6;
    border-color: #d1d5db;
  }

  .checkbox-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    margin: 0;
    accent-color: #ff6600;
  }

  .checkbox-group label {
    margin: 0;
    cursor: pointer;
    font-weight: 500;
    color: #374151;
    font-size: 0.9375rem;
  }

  .tags-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .tag-checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.875rem;
    background-color: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tag-checkbox-item:hover {
    background-color: #f9fafb;
    border-color: #ff6600;
  }

  .tag-checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    margin: 0;
    accent-color: #ff6600;
  }

  .tag-checkbox-item label {
    margin: 0;
    cursor: pointer;
    font-size: 0.875rem;
    color: #374151;
    font-weight: 500;
    flex: 1;
  }

  .tag-checkbox-item input[type="checkbox"]:checked + label {
    color: #ff6600;
    font-weight: 600;
  }

  .tag-checkbox-item:has(input[type="checkbox"]:checked) {
    background-color: #fff7ed;
    border-color: #ff6600;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 2rem;
    margin-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  .btn-cancel,
  .btn-submit {
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn-cancel {
    background-color: #ffffff;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  .btn-cancel:hover {
    background-color: #f9fafb;
    border-color: #9ca3af;
  }

  .btn-submit {
    background-color: #ff6600;
    color: #ffffff;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .btn-submit:hover {
    background-color: #e55a00;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn-draft {
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #d1d5db;
    background-color: #ffffff;
    color: #374151;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn-draft:hover {
    background-color: #f9fafb;
    border-color: #9ca3af;
  }

  .error-message {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  @media (max-width: 768px) {
    .create-news-page {
      padding: 1.5rem 1rem;
    }

    .create-news-form {
      padding: 1.5rem;
    }

    .create-news-header h1 {
      font-size: 1.75rem;
    }

    .form-actions {
      flex-direction: column;
    }

    .btn-cancel,
    .btn-submit,
    .btn-draft {
      width: 100%;
    }
  }
</style>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="create-news-page">
  <div class="create-news-wrapper">
    <div class="create-news-header">
      <h1>Create News Article</h1>
      <p>Fill in the details below to create a new news article</p>
    </div>

    <!-- Display Messages -->
    {% if messages %}
      <div style="max-width: 1000px; margin: 0 auto 1.5rem;">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}" style="
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            {% if message.tags == 'error' %}
              background-color: #fee2e2;
              color: #991b1b;
              border: 1px solid #fecaca;
            {% elif message.tags == 'success' %}
              background-color: #d1fae5;
              color: #065f46;
              border: 1px solid #a7f3d0;
            {% else %}
              background-color: #dbeafe;
              color: #1e40af;
              border: 1px solid #bfdbfe;
            {% endif %}
          ">
            {% if message.tags == 'error' %}
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            {% elif message.tags == 'success' %}
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            {% endif %}
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <form class="create-news-form" method="post" action="{% url 'app:create_news' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Basic Information Section -->
      <div class="form-section">
        <h2 class="form-section-title">Basic Information</h2>

        <div class="form-group">
          <label for="id_title">Title <span class="required">*</span></label>
          {{ form.title }}
          {% if form.title.errors %}
          <div class="error-message">{{ form.title.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="id_excerpt">Excerpt</label>
          {{ form.excerpt }}
          {% if form.excerpt.errors %}
          <div class="error-message">{{ form.excerpt.errors }}</div>
          {% endif %}
          <div class="form-hint">A brief summary of the article (optional)</div>
        </div>
      </div>

      <!-- Content Section -->
      <div class="form-section">
        <h2 class="form-section-title">Content</h2>

        <div class="form-group">
          <label for="id_content">Content <span class="required">*</span></label>
          <div class="quill-editor-wrapper">
            <div id="editor"></div>
          </div>
          <textarea id="id_content" name="content" style="display: none;">{{ form.content.value|default:'' }}</textarea>
          {% if form.content.errors %}
          <div class="error-message">{{ form.content.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Media Section -->
      <div class="form-section">
        <h2 class="form-section-title">Media</h2>

        <div class="form-group">
          <label for="id_featured_image">Featured Image</label>
          <div class="file-upload-wrapper">
            <label for="id_featured_image" class="file-upload-label">
              Choose Image
            </label>
            <input type="file" id="id_featured_image" name="featured_image" accept="image/*" class="file-upload-input" onchange="displayFileName(this)">
            <div id="fileNameDisplay" class="file-name-display" style="display: none;"></div>
          </div>
          {% if form.featured_image.errors %}
          <div class="error-message">{{ form.featured_image.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Categorization Section -->
      <div class="form-section">
        <h2 class="form-section-title">Categorization</h2>

        <div class="form-group">
          <label for="id_tags">Tags</label>
          {{ form.tags }}
          {% if form.tags.errors %}
          <div class="error-message">{{ form.tags.errors }}</div>
          {% endif %}
          <div class="tags-container">
            {% for tag in tags %}
            <div class="tag-checkbox-item">
              <input type="checkbox" id="tag_{{ tag.id }}" class="tag-checkbox" value="{{ tag.id }}">
              <label for="tag_{{ tag.id }}">{{ tag.name }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Writer is auto-set, hidden field -->
        {{ form.writer }}
      </div>

      <!-- Publication Settings -->
      <div class="form-section">
        <h2 class="form-section-title">Publication Settings</h2>

        <div class="form-group">
          <div class="checkbox-group">
            {{ form.is_published }}
            <label for="id_is_published">Publish immediately</label>
          </div>
          {% if form.is_published.errors %}
          <div class="error-message">{{ form.is_published.errors }}</div>
          {% endif %}
          <div class="form-hint" style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
            Check this box to publish the article immediately, or save as draft to publish later.
          </div>
        </div>
      </div>

      <div class="form-actions">
        <a href="{% url 'app:news' %}" class="btn-cancel" id="btn-cancel">Cancel</a>
        <button type="submit" name="action" value="draft" class="btn-draft" id="btn-draft">Save as Draft</button>
        <button type="submit" name="action" value="publish" class="btn-submit" id="btn-publish">Publish Article</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  // Initialize Quill Editor
  var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'font': [] }],
        [{ 'align': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        ['blockquote', 'code-block'],
        ['link', 'image', 'video'],
        ['clean']
      ]
    },
    placeholder: 'Enter article content...'
  });

  // Set existing content if editing
  const existingContent = document.getElementById('id_content').value;
  if (existingContent) {
    quill.root.innerHTML = existingContent;
  }

  // Sync tag checkboxes with hidden select field
  function syncTags() {
    const selectedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked'))
      .map(cb => cb.value);
    const tagsSelect = document.getElementById('id_tags');
    if (tagsSelect) {
      Array.from(tagsSelect.options).forEach(option => {
        option.selected = selectedTags.includes(option.value);
      });
    }
  }

  // Initialize checkboxes from hidden select field
  const tagsSelect = document.getElementById('id_tags');
  if (tagsSelect) {
    Array.from(tagsSelect.options).forEach(option => {
      if (option.selected) {
        const checkbox = document.getElementById('tag_' + option.value);
        if (checkbox) checkbox.checked = true;
      }
    });
  }

  // Update hidden select when checkboxes change
  document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', syncTags);
  });

  // Handle form submission
  const form = document.querySelector('.create-news-form');
  form.addEventListener('submit', function(e) {
    const content = document.getElementById('id_content');
    const contentValue = quill.root.innerHTML.trim();
    
    console.log('Form submitting...');
    console.log('Content value:', contentValue);
    console.log('Content length:', contentValue.length);
    
    // Check if content is empty (only HTML tags)
    const textContent = quill.root.textContent.trim();
    if (!textContent || textContent.length === 0) {
      e.preventDefault();
      alert('Please enter article content.');
      quill.focus();
      return false;
    }
    
    // Check if title is filled
    const title = document.getElementById('id_title').value.trim();
    if (!title) {
      e.preventDefault();
      alert('Please enter an article title.');
      document.getElementById('id_title').focus();
      return false;
    }
    
    // Update content and tags BEFORE form submission
    content.value = contentValue;
    console.log('Content field value after update:', content.value);
    
    // Sync tags
    syncTags();
    
    // Verify content is set
    if (!content.value || content.value.trim().length === 0) {
      e.preventDefault();
      alert('Error: Content could not be saved. Please try again.');
      return false;
    }
    
    // Disable buttons to prevent double submission
    const submitButtons = form.querySelectorAll('button[type="submit"]');
    submitButtons.forEach(btn => {
      btn.disabled = true;
      btn.textContent = btn.id === 'btn-draft' ? 'Saving Draft...' : 'Publishing...';
    });
    
    // Allow form to submit normally
    console.log('Form validation passed, submitting...');
    return true;
  });
  
  // Ensure form is ready
  console.log('Form initialized');

  // Display file name when image is selected
  function displayFileName(input) {
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    if (input.files && input.files[0]) {
      fileNameDisplay.textContent = 'Selected: ' + input.files[0].name;
      fileNameDisplay.style.display = 'block';
    } else {
      fileNameDisplay.style.display = 'none';
    }
  }
</script>
{% endblock %}
