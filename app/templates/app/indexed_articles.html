{% extends 'app/base.html' %}
{% load static %}

{% block title %}Indexed Articles - ScholarIndex{% endblock %}

{% block content %}
<style>
  .indexed-articles-page {
    padding: 2rem;
    background-color: #f9fafb;
    min-height: calc(100vh - 5rem);
  }

  .articles-container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 2rem;
    padding: 0;
  }

  .main-content {
    min-width: 0;
    max-width: 800px;
  }

  /* Search Bar */
  .search-bar-container {
    margin-bottom: 2rem;
  }

  .search-bar {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.9375rem;
    background-color: #ffffff;
    transition: all 0.2s;
  }

  .search-bar:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* Filter Sidebar */
  .filter-sidebar {
    position: sticky;
    top: 100px;
    height: fit-content;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
  }

  .filter-section {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    overflow: hidden;
  }

  .filter-header {
    padding: 0.75rem;
    background-color: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 0.875rem;
    color: #111827;
    user-select: none;
  }

  .filter-header:hover {
    background-color: #f9fafb;
  }

  .filter-header svg {
    width: 16px;
    height: 16px;
    transition: transform 0.2s;
  }

  .filter-section.collapsed .filter-header svg {
    transform: rotate(-90deg);
  }

  .filter-content {
    padding: 0.75rem;
    display: block;
  }

  .filter-section.collapsed .filter-content {
    display: none;
  }

  .filter-search {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.8125rem;
    margin-bottom: 0.5rem;
    background-color: #ffffff;
  }

  .filter-search:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .filter-list {
    max-height: 200px;
    overflow-y: auto;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .filter-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.375rem 0;
    cursor: pointer;
  }

  .filter-item:hover {
    background-color: #f9fafb;
    margin: 0 -0.5rem;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }

  .filter-item input[type="checkbox"] {
    margin-right: 0.5rem;
    cursor: pointer;
  }

  .filter-item-label {
    flex: 1;
    font-size: 0.8125rem;
    color: #374151;
    cursor: pointer;
  }

  .filter-count {
    background-color: #f97316;
    color: #ffffff;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    min-width: 32px;
    text-align: center;
  }

  .reset-button {
    width: 100%;
    padding: 0.625rem 1rem;
    background-color: #dc2626;
    color: #ffffff;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
    margin-top: 0.5rem;
  }

  .reset-button:hover {
    background-color: #b91c1c;
  }

  /* Pagination */
  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding: 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
  }

  .pagination-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.875rem;
  }

  .pagination-info span {
    color: #374151;
  }

  .pagination-info .pagination-value {
    color: #f97316;
    font-weight: 600;
  }

  .pagination-info-separator {
    width: 1px;
    height: 1.5rem;
    background: #e5e7eb;
  }

  .pagination-page-select {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pagination-page-select span {
    color: #374151;
  }

  .page-input {
    padding: 0.375rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    background: white;
    color: #111827;
    cursor: pointer;
    min-width: 60px;
  }

  .page-input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .limit-input {
    padding: 0.375rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    background: white;
    color: #111827;
    cursor: pointer;
    min-width: 60px;
  }

  .limit-input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .pagination-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pagination-btn {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    background: white;
    color: #111827;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
    cursor: pointer;
  }

  .pagination-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .pagination-btn.active {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  .pagination-btn.arrow {
    color: #111827;
  }

  .pagination-btn.arrow.next {
    color: #f97316;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .page-header p {
    font-size: 1rem;
    color: #6b7280;
    margin: 0;
  }

  .articles-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .article-card {
    background-color: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem 1rem 0.5rem 1rem;
    transition: all 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    margin-bottom: 1rem;
  }

  .article-card:hover {
    border-color: #d1d5db;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }

  .article-thumbnail {
    width: 200px;
    height: 120px;
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
  }

  .article-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-thumbnail-placeholder {
    width: 100%;
    height: 100%;
    background-color: #6366f1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
    font-size: 2rem;
    font-weight: 600;
  }

  .article-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    gap: 0.375rem;
    padding-bottom: 0;
  }

  .article-title {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #111827;
    line-height: 1.4;
    margin: 0 0 0.25rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-authors {
    font-size: 0.875rem;
    color: #10b981;
    font-weight: 500;
    margin: 0 0 0.375rem 0;
    line-height: 1.4;
  }

  .article-snippet {
    font-size: 0.875rem;
    color: #374151;
    line-height: 1.6;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.125rem;
    margin-bottom: 0;
  }

  .article-platform-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
  }

  .article-platform-icon.instagram {
    background-color: #e4405f;
    color: white;
  }

  .article-platform-icon.facebook {
    background-color: #1877f2;
    color: white;
  }

  .article-platform-icon.twitter {
    background-color: #1da1f2;
    color: white;
  }

  .article-platform-icon.journal {
    background-color: #059669;
    color: white;
  }

  .article-platform-icon.research {
    background-color: #4f46e5;
    color: white;
  }

  .article-platform-text {
    font-size: 0.875rem;
    color: #f97316;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .empty-state h3 {
    font-size: 1.5rem;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: #6b7280;
    font-size: 1rem;
  }

  @media (max-width: 768px) {
    .indexed-articles-page {
      padding: 1.5rem 1rem;
    }

    .page-header h1 {
      font-size: 1.75rem;
    }

    .article-card {
      flex-direction: column;
      padding: 1rem;
    }

    .article-thumbnail {
      width: 100%;
      height: 150px;
    }

    .articles-container {
      grid-template-columns: 1fr;
    }

    .filter-sidebar {
      position: relative;
      top: 0;
      max-height: none;
    }
  }
</style>

<div class="indexed-articles-page">
  <div class="articles-container">
    <!-- Filter Sidebar -->
    <aside class="filter-sidebar">
      <!-- Subject Filter -->
      <div class="filter-section" id="subject-filter">
        <div class="filter-header" onclick="toggleFilter('subject-filter')">
          <span>SUBJECT</span>
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div class="filter-content">
          <input type="text" class="filter-search" id="subject-search" placeholder="Search subject" onkeyup="filterSubjects()">
          <ul class="filter-list" id="subject-list">
            {% for subject in subjects %}
            <li class="filter-item">
              <label class="filter-item-label">
                <input type="checkbox" class="filter-checkbox" data-type="subject" data-value="{{ subject.name }}" onchange="applyFilters()">
                <span>{{ subject.name }}</span>
              </label>
              <span class="filter-count">{{ subject.count }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Journal Filter -->
      <div class="filter-section collapsed" id="journal-filter">
        <div class="filter-header" onclick="toggleFilter('journal-filter')">
          <span>JOURNAL</span>
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div class="filter-content">
          <input type="text" class="filter-search" id="journal-search" placeholder="Search journal" onkeyup="filterJournals()">
          <ul class="filter-list" id="journal-list">
            {% for journal in journals %}
            <li class="filter-item">
              <label class="filter-item-label">
                <input type="checkbox" class="filter-checkbox" data-type="journal" data-value="{{ journal.name }}" onchange="applyFilters()">
                <span>{{ journal.name }}</span>
              </label>
              <span class="filter-count">{{ journal.count }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Year Filter -->
      <div class="filter-section collapsed" id="year-filter">
        <div class="filter-header" onclick="toggleFilter('year-filter')">
          <span>YEAR OF PUBLICATION</span>
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div class="filter-content">
          <ul class="filter-list" id="year-list">
            {% for year in years %}
            <li class="filter-item">
              <label class="filter-item-label">
                <input type="checkbox" class="filter-checkbox" data-type="year" data-value="{{ year.name }}" onchange="applyFilters()">
                <span>{{ year.name }}</span>
              </label>
              <span class="filter-count">{{ year.count }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <button class="reset-button" onclick="resetFilters()">Reset</button>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1>Indexed Articles</h1>
        <p>Browse through our comprehensive collection of indexed research articles</p>
      </div>

      <!-- Search Bar -->
      <div class="search-bar-container">
        <input type="text" class="search-bar" id="article-search" placeholder="Search articles by title, author, or abstract..." onkeyup="filterArticles()">
      </div>

      <!-- Articles List -->
      <div class="articles-list" id="articles-list">
      {% if articles_with_time %}
        {% for item in articles_with_time %}
          {% with article=item.article time_ago=item.time_ago %}
          <a href="{% url 'app:article_detail' article.id %}" class="article-card">
            <!-- Thumbnail -->
            <div class="article-thumbnail">
              {% if article.cover_image %}
                <img src="{{ article.cover_image.url }}" alt="{{ article.title }}">
              {% else %}
                <div class="article-thumbnail-placeholder">
                  {{ article.title|slice:":1"|upper }}
                </div>
              {% endif %}
            </div>

            <!-- Content -->
            <div class="article-content">
              <h3 class="article-title">{{ article.title }}</h3>
              
              {% if article.authors_names %}
                <p class="article-authors">{{ article.authors_names }}</p>
              {% elif article.articleauthor_set.all %}
                <p class="article-authors">
                  {% for author in article.articleauthor_set.all %}
                    {{ author.name }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </p>
              {% endif %}

              {% if article.abstract %}
                <p class="article-snippet">
                  {% autoescape off %}
                    {{ article.abstract|striptags|truncatewords:30 }}
                  {% endautoescape %}
                </p>
              {% endif %}

              <div class="article-meta">
                <span class="article-platform-text">{{ time_ago }}</span>
              </div>
            </div>
          </a>
          {% endwith %}
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <h3>No Articles Found</h3>
          <p>There are no indexed articles available at the moment.</p>
        </div>
      {% endif %}
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages or page_obj.paginator.count > 0 %}
      <div class="pagination-container">
        <div class="pagination-info">
          <span>Records: <span class="pagination-value">{{ end_record }}</span> of <span class="pagination-value">{{ total_records }}</span></span>
          <div class="pagination-info-separator"></div>
          <div class="pagination-page-select">
            <span>Page :</span>
            <select class="page-input" onchange="goToPage(this.value)">
              {% for page_num in page_obj.paginator.page_range %}
                <option value="{{ page_num }}" {% if page_num == page_obj.number %}selected{% endif %}>{{ page_num }}</option>
              {% endfor %}
            </select>
            <span>of <span class="pagination-value">{{ page_obj.paginator.num_pages }}</span></span>
          </div>
          <div class="pagination-info-separator"></div>
          <div class="pagination-page-select">
            <span>Limit</span>
            <select class="limit-input" onchange="changeLimit(this.value)">
              <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
              <option value="40" {% if per_page == 40 %}selected{% endif %}>40</option>
              <option value="60" {% if per_page == 60 %}selected{% endif %}>60</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
          </div>
        </div>
        
        <div class="pagination-nav">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if per_page != 40 %}&limit={{ per_page }}{% endif %}" class="pagination-btn arrow">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </a>
          {% else %}
            <span class="pagination-btn arrow" style="opacity: 0.5; cursor: not-allowed;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </span>
          {% endif %}
          
          {% for page_num in page_obj.paginator.page_range %}
            {% if page_num == page_obj.number %}
              <span class="pagination-btn active">{{ page_num }}</span>
            {% elif page_num <= 5 %}
              <a href="?page={{ page_num }}{% if per_page != 40 %}&limit={{ per_page }}{% endif %}" class="pagination-btn">{{ page_num }}</a>
            {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if per_page != 40 %}&limit={{ per_page }}{% endif %}" class="pagination-btn arrow next">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
          {% else %}
            <span class="pagination-btn arrow next" style="opacity: 0.5; cursor: not-allowed;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </span>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Store all articles data for filtering
  const allArticles = [
    {% for item in articles_with_time %}
    {
      id: {{ item.article.id }},
      title: "{{ item.article.title|escapejs }}",
      authors: "{{ item.article.authors_names|default:""|escapejs }}",
      abstract: "{{ item.article.abstract|default:""|escapejs }}",
      discipline: "{{ item.article.discipline|escapejs }}",
      journal: "{{ item.article.journal_name|default:""|escapejs }}",
      year: {% if item.article.year_of_publication %}{{ item.article.year_of_publication }}{% else %}null{% endif %},
      timeAgo: "{{ item.time_ago|escapejs }}",
      coverImage: {% if item.article.cover_image %}"{{ item.article.cover_image.url|escapejs }}"{% else %}""{% endif %},
      url: "{% url 'app:article_detail' item.article.id %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  function toggleFilter(filterId) {
    const section = document.getElementById(filterId);
    section.classList.toggle('collapsed');
  }

  function filterSubjects() {
    const searchTerm = document.getElementById('subject-search').value.toLowerCase();
    const items = document.querySelectorAll('#subject-list .filter-item');
    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
  }

  function filterJournals() {
    const searchTerm = document.getElementById('journal-search').value.toLowerCase();
    const items = document.querySelectorAll('#journal-list .filter-item');
    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
  }

  function applyFilters() {
    const selectedSubjects = Array.from(document.querySelectorAll('input[data-type="subject"]:checked')).map(cb => cb.dataset.value);
    const selectedJournals = Array.from(document.querySelectorAll('input[data-type="journal"]:checked')).map(cb => cb.dataset.value);
    const selectedYears = Array.from(document.querySelectorAll('input[data-type="year"]:checked')).map(cb => cb.dataset.value);
    const searchTerm = document.getElementById('article-search').value.toLowerCase();

    const articlesList = document.getElementById('articles-list');
    let visibleCount = 0;

    articlesList.querySelectorAll('.article-card').forEach((card, index) => {
      if (index >= allArticles.length) return;
      
      const article = allArticles[index];
      let visible = true;

      // Filter by search term
      if (searchTerm) {
        const matchesSearch = 
          (article.title || '').toLowerCase().includes(searchTerm) ||
          (article.authors || '').toLowerCase().includes(searchTerm) ||
          (article.abstract || '').toLowerCase().includes(searchTerm);
        if (!matchesSearch) visible = false;
      }

      // Filter by subject
      if (selectedSubjects.length > 0) {
        const articleDiscipline = article.discipline || '';
        if (!selectedSubjects.includes(articleDiscipline)) {
          visible = false;
        }
      }

      // Filter by journal
      if (selectedJournals.length > 0) {
        const articleJournal = article.journal || '';
        if (!selectedJournals.includes(articleJournal)) {
          visible = false;
        }
      }

      // Filter by year
      if (selectedYears.length > 0) {
        const articleYear = article.year ? String(article.year) : '';
        if (!selectedYears.includes(articleYear)) {
          visible = false;
        }
      }

      if (visible) {
        card.style.display = 'flex';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Show empty state if no articles visible
    const existingEmptyState = articlesList.querySelector('.empty-state');
    if (visibleCount === 0) {
      if (!existingEmptyState) {
        const emptyStateDiv = document.createElement('div');
        emptyStateDiv.className = 'empty-state';
        emptyStateDiv.innerHTML = '<h3>No Articles Found</h3><p>No articles match your search criteria.</p>';
        articlesList.appendChild(emptyStateDiv);
      }
    } else {
      if (existingEmptyState) {
        existingEmptyState.remove();
      }
    }
  }

  function filterArticles() {
    applyFilters();
  }

  function resetFilters() {
    // Clear search
    document.getElementById('article-search').value = '';
    
    // Clear all checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
    
    // Clear filter searches
    document.getElementById('subject-search').value = '';
    document.getElementById('journal-search').value = '';
    
    // Show all subjects and journals
    document.querySelectorAll('.filter-item').forEach(item => {
      item.style.display = 'flex';
    });
    
    // Show all articles
    document.querySelectorAll('.article-card').forEach(card => {
      card.style.display = 'flex';
    });

    // Remove empty state if exists
    const emptyState = document.querySelector('.empty-state');
    if (emptyState && allArticles.length > 0) {
      emptyState.remove();
    }
  }

  // Initialize - make sure all articles are visible on load
  document.addEventListener('DOMContentLoaded', function() {
    if (allArticles.length > 0) {
      applyFilters();
    }
  });

  // Pagination functions
  function goToPage(pageNum) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('page', pageNum);
    const limit = urlParams.get('limit');
    if (limit && limit !== '40') {
      urlParams.set('limit', limit);
    }
    window.location.search = urlParams.toString();
  }

  function changeLimit(limit) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('limit', limit);
    urlParams.set('page', '1'); // Reset to first page when changing limit
    window.location.search = urlParams.toString();
  }
</script>
{% endblock %}

