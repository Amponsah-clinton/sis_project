{% extends 'app/base.html' %}
{% load static %}

{% block title %}New Project Archive - ScholarIndex{% endblock %}

{% block content %}
<style>
  .upload-project-page {
    padding: 2rem 1.5rem 3rem;
    background-color: #f9fafb;
    min-height: calc(100vh - 5rem);
  }

  .upload-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .upload-header {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .upload-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .upload-form {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 2.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .form-group label .required {
    color: #ef4444;
    margin-left: 0.25rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .form-row-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  /* File Upload Styling */
  .file-upload-wrapper {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 3rem 2rem;
    text-align: center;
    background-color: #f9fafb;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
  }

  .file-upload-wrapper:hover {
    border-color: #3b82f6;
    background-color: #eff6ff;
  }

  .file-upload-wrapper.drag-over {
    border-color: #3b82f6;
    background-color: #dbeafe;
  }

  .file-upload-wrapper.has-file {
    border-color: #10b981;
    background-color: #d1fae5;
  }

  .file-input {
    position: absolute;
    width: 0;
    height: 0;
    opacity: 0;
    overflow: hidden;
  }

  .file-upload-text {
    font-size: 0.9375rem;
    color: #6b7280;
    margin: 0;
  }

  /* Input and Select Styling */
  .form-group input[type="text"],
  .form-group input[type="number"],
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.9375rem;
    color: #111827;
    background-color: #ffffff;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group input:disabled {
    background-color: #f3f4f6;
    cursor: not-allowed;
    opacity: 0.7;
  }

  .form-group input.auto-detected {
    border-color: #10b981;
    background-color: #f0fdf4;
  }

  .form-group select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 120px;
    font-family: inherit;
  }

  /* Rich Text Editor Styling */
  .rich-text-editor {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    overflow: hidden;
    background-color: #ffffff;
  }

  .rich-text-toolbar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background-color: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    flex-wrap: wrap;
  }

  .toolbar-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: transparent;
    border-radius: 4px;
    cursor: pointer;
    color: #6b7280;
    transition: all 0.2s ease;
  }

  .toolbar-btn:hover {
    background-color: #e5e7eb;
    color: #111827;
  }

  .toolbar-btn.active {
    background-color: #dbeafe;
    color: #3b82f6;
  }

  .toolbar-separator {
    width: 1px;
    height: 24px;
    background-color: #e5e7eb;
    margin: 0 0.25rem;
  }

  .toolbar-select {
    padding: 0.375rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.8125rem;
    background-color: #ffffff;
    color: #374151;
    cursor: pointer;
  }

  .rich-text-content {
    min-height: 300px;
    padding: 1rem;
    border: none;
    outline: none;
    font-size: 0.9375rem;
    line-height: 1.6;
    color: #111827;
    font-family: inherit;
  }

  .rich-text-content:focus {
    outline: none;
  }

  .rich-text-content[data-placeholder]:empty:before {
    content: attr(data-placeholder);
    color: #9ca3af;
  }

  /* Checkbox Styling */
  .checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-top: 0.125rem;
    cursor: pointer;
    accent-color: #3b82f6;
    flex-shrink: 0;
  }

  .checkbox-group label {
    font-size: 0.875rem;
    color: #374151;
    margin: 0;
    cursor: pointer;
    line-height: 1.5;
  }

  .checkbox-group a {
    color: #3b82f6;
    text-decoration: none;
  }

  .checkbox-group a:hover {
    text-decoration: underline;
  }

  /* Submit Button */
  .form-actions {
    display: flex;
    justify-content: center;
    margin-top: 2.5rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
  }

  .btn-submit {
    padding: 0.875rem 2.5rem;
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: #ffffff;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
  }

  .btn-submit:hover {
    background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
    transform: translateY(-1px);
  }

  .btn-submit:active {
    transform: translateY(0);
  }

  .btn-submit svg {
    width: 20px;
    height: 20px;
  }

  .file-name-display {
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #ffffff;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #059669;
    font-weight: 500;
    display: none;
  }

  .file-name-display.show {
    display: block;
  }

  @media (max-width: 768px) {
    .upload-project-page {
      padding: 1.5rem 1rem;
    }

    .upload-form {
      padding: 1.5rem;
    }

    .upload-header {
      padding: 1.5rem;
    }

    .upload-header h1 {
      font-size: 1.5rem;
    }

    .form-row,
    .form-row-3 {
      grid-template-columns: 1fr;
      gap: 0;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .rich-text-toolbar {
      gap: 0.375rem;
      padding: 0.5rem;
    }

    .toolbar-btn {
      width: 28px;
      height: 28px;
    }

    .rich-text-content {
      min-height: 250px;
      padding: 0.75rem;
    }

    .file-upload-wrapper {
      padding: 2rem 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .upload-project-page {
      padding: 1rem 0.75rem;
    }

    .upload-form {
      padding: 1.25rem;
    }

    .upload-header {
      padding: 1.25rem;
    }

    .btn-submit {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<div class="upload-project-page">
  <div class="upload-container">
    <div class="upload-header">
      <h1>New Project Archive</h1>
    </div>

    <form class="upload-form" method="post" action="{% url 'app:upload_project' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- File Upload -->
      <div class="form-group">
        <label>File <span class="required">*</span></label>
        <div class="file-upload-wrapper" id="fileUploadArea" onclick="document.getElementById('project_file').click()">
          <input type="file" id="project_file" name="project_file" accept=".pdf,.doc,.docx,.zip" class="file-input" required onchange="handleFileSelect(event)">
          <p class="file-upload-text">Choose files or drag and drop files to upload</p>
          <div class="file-name-display" id="fileName"></div>
        </div>
      </div>

      <!-- Subject and Discipline -->
      <div class="form-row">
        <div class="form-group">
          <label for="subject">Subject <span class="required">*</span></label>
          <select id="subject" name="subject" required>
            <option value="">Select a value...</option>
            <option value="medicine-health">Medicine and Health</option>
            <option value="technology">Technology</option>
            <option value="engineering">Engineering</option>
            <option value="computer-science">Computer Science</option>
            <option value="art-humanities">Art and Humanities</option>
            <option value="social-science">Social Science and Behavioral Sciences</option>
            <option value="physics">Physics</option>
            <option value="chemistry">Chemistry</option>
            <option value="biology">Biology</option>
          </select>
        </div>

        <div class="form-group">
          <label for="discipline">Discipline <span class="required">*</span></label>
          <select id="discipline" name="category" required>
            <option value="">Select a value...</option>
            <option value="medicine-health">Medicine and Health</option>
            <option value="technology">Technology</option>
            <option value="engineering">Engineering</option>
            <option value="computer-science">Computer Science</option>
            <option value="art-humanities">Art and Humanities</option>
            <option value="social-science">Social Science and Behavioral Sciences</option>
            <option value="physics">Physics</option>
            <option value="chemistry">Chemistry</option>
            <option value="biology">Biology</option>
          </select>
        </div>
      </div>

      <!-- Price, Chapters, Pages -->
      <div class="form-row-3">
        <div class="form-group">
          <label for="price_usd">Price in USD <span class="required">*</span></label>
          <input type="number" id="price_usd" name="price_usd" step="0.01" min="0" placeholder="Enter Price in USD" required>
        </div>

        <div class="form-group">
          <label for="chapters">Chapters <span class="required">*</span></label>
          <input type="number" id="chapters" name="chapters" min="1" placeholder="Enter Chapters" required>
        </div>

        <div class="form-group">
          <label for="pages">Pages <span class="required">*</span></label>
          <input type="number" id="pages" name="pages" min="1" placeholder="Enter Pages" required>
        </div>
      </div>

      <!-- Project Topic -->
      <div class="form-group">
        <label for="project_topic">Project Topic <span class="required">*</span></label>
        <textarea id="project_topic" name="project_title" placeholder="Enter Project Topic" required></textarea>
      </div>

      <!-- Overview -->
      <div class="form-group">
        <label>Overview <span class="required">*</span></label>
        <div class="rich-text-editor">
          <div class="rich-text-toolbar">
            <button type="button" class="toolbar-btn" onclick="document.execCommand('undo', false, null)" title="Undo">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('redo', false, null)" title="Redo">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6-6m6 6l-6 6"></path>
              </svg>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('bold', false, null)" title="Bold">
              <strong>B</strong>
            </button>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('underline', false, null)" title="Underline">
              <u>U</u>
            </button>
            <div class="toolbar-separator"></div>
            <select class="toolbar-select" onchange="document.execCommand('fontName', false, this.value)">
              <option value="Roboto">Roboto</option>
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Courier New">Courier New</option>
            </select>
            <button type="button" class="toolbar-btn" onclick="showColorPicker('foreColor')" title="Text Color">
              <span style="text-decoration: underline; color: #fbbf24;">A</span>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('justifyLeft', false, null)" title="Align Left">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('justifyCenter', false, null)" title="Align Center">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('justifyRight', false, null)" title="Align Right">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('justifyFull', false, null)" title="Justify">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('insertUnorderedList', false, null)" title="Bullet List">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="document.execCommand('insertOrderedList', false, null)" title="Numbered List">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"></path>
              </svg>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" class="toolbar-btn" onclick="insertLink()" title="Insert Link">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertImage()" title="Insert Image">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertVideo()" title="Insert Video">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" onclick="insertTable()" title="Insert Table">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" class="toolbar-btn" onclick="toggleCodeView()" title="Code View">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
              </svg>
            </button>
            <button type="button" class="toolbar-btn" title="Help">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </button>
          </div>
          <div class="rich-text-content" id="overviewEditor" contenteditable="true" data-placeholder="Enter overview..."></div>
          <textarea id="description" name="description" style="display: none;" required></textarea>
        </div>
      </div>

      <!-- Terms and Conditions -->
      <div class="checkbox-group">
        <input type="checkbox" id="terms" name="terms" required>
        <label for="terms">
          By continuing you agree with our <a href="{% url 'app:policy_terms' %}" target="_blank">Terms and Conditions</a> and <a href="{% url 'app:policy_terms' %}" target="_blank">Privacy policy</a>.
        </label>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button type="submit" class="btn-submit">
          Submit
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- PDF.js for page counting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // Configure PDF.js worker
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
  });

  // File upload handling with automatic page detection
  async function handleFileSelect(event) {
    const file = event.target.files[0];
    const fileName = document.getElementById('fileName');
    const uploadArea = document.getElementById('fileUploadArea');
    const pagesInput = document.getElementById('pages');
    
    if (file) {
      fileName.textContent = file.name;
      fileName.classList.add('show');
      uploadArea.classList.add('has-file');
      
      // Detect pages automatically
      const fileExtension = file.name.split('.').pop().toLowerCase();
      
      if (fileExtension === 'pdf') {
        // Count PDF pages using PDF.js
        if (typeof pdfjsLib === 'undefined') {
          console.error('PDF.js library not loaded');
          if (pagesInput) {
            pagesInput.placeholder = 'PDF.js not loaded - Enter Pages manually';
          }
          return;
        }
        
        try {
          // Show loading state
          if (pagesInput) {
            pagesInput.value = '';
            pagesInput.placeholder = 'Counting pages...';
            pagesInput.disabled = true;
          }
          
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          const pageCount = pdf.numPages;
          
          if (pagesInput) {
            pagesInput.value = pageCount;
            pagesInput.placeholder = 'Enter Pages';
            pagesInput.disabled = false;
            pagesInput.classList.add('auto-detected');
            pagesInput.dispatchEvent(new Event('input', { bubbles: true }));
            console.log('Detected', pageCount, 'pages in PDF');
            
            // Remove the auto-detected class after a moment
            setTimeout(() => {
              pagesInput.classList.remove('auto-detected');
            }, 2000);
          }
        } catch (error) {
          console.error('Error counting PDF pages:', error);
          // Show error state
          if (pagesInput) {
            pagesInput.value = '';
            pagesInput.placeholder = 'Error counting - Enter Pages manually';
            pagesInput.disabled = false;
            setTimeout(() => {
              pagesInput.placeholder = 'Enter Pages';
            }, 3000);
          }
        }
      } else if (fileExtension === 'doc' || fileExtension === 'docx') {
        // For Word documents, we can't easily count pages client-side
        // But we can try to estimate based on file size (rough estimate)
        // 1 page â‰ˆ 50-100KB for typical documents
        const fileSizeKB = file.size / 1024;
        const estimatedPages = Math.max(1, Math.round(fileSizeKB / 75));
        if (pagesInput) {
          pagesInput.value = estimatedPages;
          pagesInput.classList.add('auto-detected');
          pagesInput.dispatchEvent(new Event('input', { bubbles: true }));
          console.log('Estimated', estimatedPages, 'pages based on file size');
          
          // Show a note that it's an estimate
          let note = document.getElementById('pages-estimate-note');
          if (!note) {
            note = document.createElement('small');
            note.textContent = ' (estimated - please verify)';
            note.style.color = '#6b7280';
            note.style.fontSize = '0.75rem';
            note.style.marginTop = '0.25rem';
            note.style.display = 'block';
            note.id = 'pages-estimate-note';
            pagesInput.parentElement.appendChild(note);
          }
          
          // Remove the auto-detected class after a moment
          setTimeout(() => {
            pagesInput.classList.remove('auto-detected');
          }, 2000);
        }
      } else if (fileExtension === 'zip') {
        // For ZIP files, we can't determine pages
        if (pagesInput) {
          pagesInput.placeholder = 'Enter Pages (ZIP file)';
        }
      }
    } else {
      fileName.textContent = '';
      fileName.classList.remove('show');
      uploadArea.classList.remove('has-file');
      // Clear pages if file is removed
      if (pagesInput) {
        pagesInput.value = '';
        pagesInput.classList.remove('auto-detected');
        pagesInput.placeholder = 'Enter Pages';
        const note = document.getElementById('pages-estimate-note');
        if (note) note.remove();
      }
    }
  }

  // Drag and drop for file upload
  const fileUploadArea = document.getElementById('fileUploadArea');
  const fileInput = document.getElementById('project_file');

  fileUploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    fileUploadArea.classList.add('drag-over');
  });

  fileUploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    fileUploadArea.classList.remove('drag-over');
  });

  fileUploadArea.addEventListener('drop', async function(e) {
    e.preventDefault();
    fileUploadArea.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      await handleFileSelect({ target: fileInput });
    }
  });

  // Rich text editor functions
  function showColorPicker(command) {
    const color = prompt('Enter color (e.g., #ff0000 or red):');
    if (color) {
      document.execCommand(command, false, color);
    }
  }

  function insertLink() {
    const url = prompt('Enter URL:');
    if (url) {
      document.execCommand('createLink', false, url);
    }
  }

  function insertImage() {
    const url = prompt('Enter image URL:');
    if (url) {
      document.execCommand('insertImage', false, url);
    }
  }

  function insertVideo() {
    const url = prompt('Enter video URL:');
    if (url) {
      const video = document.createElement('iframe');
      video.src = url;
      video.width = '560';
      video.height = '315';
      video.frameBorder = '0';
      document.execCommand('insertHTML', false, video.outerHTML);
    }
  }

  function insertTable() {
    const rows = prompt('Number of rows:', '3');
    const cols = prompt('Number of columns:', '3');
    if (rows && cols) {
      let table = '<table border="1" style="border-collapse: collapse; width: 100%;">';
      for (let i = 0; i < rows; i++) {
        table += '<tr>';
        for (let j = 0; j < cols; j++) {
          table += '<td style="padding: 8px;">&nbsp;</td>';
        }
        table += '</tr>';
      }
      table += '</table>';
      document.execCommand('insertHTML', false, table);
    }
  }

  function toggleCodeView() {
    const editor = document.getElementById('overviewEditor');
    const isCodeView = editor.classList.toggle('code-view');
    if (isCodeView) {
      editor.style.fontFamily = 'monospace';
      editor.style.whiteSpace = 'pre';
    } else {
      editor.style.fontFamily = '';
      editor.style.whiteSpace = '';
    }
  }

  function initializeForm() {
    // Sync rich text editor content to hidden textarea on input
    const editor = document.getElementById('overviewEditor');
    const textarea = document.getElementById('description');
    
    if (editor && textarea) {
      // Update textarea whenever editor content changes
      editor.addEventListener('input', function() {
        let content = this.innerHTML.trim();
        // Don't save placeholder as content
        if (content && this.textContent.trim() !== this.dataset.placeholder) {
          textarea.value = content;
        }
      });
      
      // Also sync on blur
      editor.addEventListener('blur', function() {
        let content = this.innerHTML.trim();
        let text = this.textContent.trim();
        if (text && text !== this.dataset.placeholder) {
          textarea.value = content;
        }
      });
    }

    // Sync rich text editor content to hidden textarea before submit
    const form = document.querySelector('.upload-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        
        if (!editor || !textarea) {
          console.error('Editor or textarea not found');
          return;
        }
        
        // Get the actual content (text or HTML)
        let editorContent = editor.innerHTML.trim();
        let editorText = editor.textContent.trim();
        
        // Remove placeholder if it exists
        const placeholder = editor.dataset.placeholder || 'Enter overview...';
        if (editorText === placeholder) {
          editorText = '';
          editorContent = '';
        }
        
        // Clean up empty HTML tags
        editorContent = editorContent.replace(/<br\s*\/?>/gi, '');
        editorContent = editorContent.replace(/<div><\/div>/gi, '');
        editorContent = editorContent.trim();
        
        console.log('Editor text:', editorText);
        console.log('Editor content:', editorContent);
        
        // Check if editor is empty
        if (!editorText || !editorContent || editorContent === '' || editorContent === '<div></div>') {
          e.preventDefault();
          alert('Please enter an overview in the Overview field.');
          editor.focus();
          return false;
        }
        
        // Sync content to hidden textarea
        textarea.value = editorContent;
        console.log('Form submitting with description length:', editorContent.length);
        
        // Validate other required fields
        const fileInput = document.getElementById('project_file');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          e.preventDefault();
          alert('Please select a file to upload.');
          return false;
        }
        
        const subject = document.getElementById('subject');
        if (!subject || !subject.value) {
          e.preventDefault();
          alert('Please select a subject.');
          return false;
        }
        
        const category = document.getElementById('discipline');
        if (!category || !category.value) {
          e.preventDefault();
          alert('Please select a discipline.');
          return false;
        }
        
        console.log('All validations passed, submitting form...');
      });
    }
  }
</script>
{% endblock %}
