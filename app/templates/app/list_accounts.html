{% extends 'app/base.html' %}
{% load static %}

{% block title %}List Accounts - ScholarIndex{% endblock %}

{% block extra_css %}
<style>
  .list-accounts-page {
    min-height: calc(100vh - 5rem);
    background-color: #f9fafb;
    padding: 2rem 1rem;
  }

  .list-accounts-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .page-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 1rem 0;
  }

  .search-filter-bar {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: nowrap;
    justify-content: space-between;
  }
  
  .search-filter-left {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: nowrap;
    flex: 1;
  }
  
  .search-filter-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .search-input {
    width: 320px;
    min-width: 250px;
    max-width: 320px;
    padding: 0.625rem 1rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
    flex-shrink: 0;
  }

  .search-input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .sort-select {
    padding: 0.625rem 1rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s ease;
    flex-shrink: 0;
    min-width: 140px;
  }

  .sort-select:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .accounts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .account-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    position: relative;
  }

  .account-card:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  /* Ensure popover stays visible when interacting with it */
  .account-card:hover .account-role-selector,
  .account-role-selector:hover {
    display: block !important;
    opacity: 1;
  }

  .account-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .account-avatar {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
  }

  .account-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .account-info {
    flex: 1;
    min-width: 0;
  }

  .account-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.25rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .account-email {
    font-size: 0.75rem;
    color: #6b7280;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .account-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #f3f4f6;
  }

  .view-btn {
    flex: 1;
    padding: 0.5rem 1rem;
    background: white;
    color: #3b82f6;
    border: 1.5px solid #3b82f6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    text-align: center;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .view-btn:hover {
    background: #3b82f6;
    color: white;
  }

  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding: 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
  }

  .pagination-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #f97316;
    font-size: 0.875rem;
  }

  .pagination-info-separator {
    width: 1px;
    height: 1.5rem;
    background: #e5e7eb;
  }

  .pagination-page-select {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #f97316;
    font-size: 0.875rem;
  }

  .page-input {
    width: 3rem;
    padding: 0.375rem 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    text-align: center;
    appearance: none;
    background: white;
    cursor: pointer;
  }

  .pagination-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pagination-btn {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    background: white;
    color: #111827;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .pagination-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .pagination-btn.active {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  .pagination-btn.arrow {
    color: #111827;
  }

  .no-results {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  .results-count-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
  }

  .results-count-number {
    background: transparent;
    color: #3b82f6;
    padding: 0.25rem 0;
    border-radius: 0;
    font-weight: 700;
    font-size: 0.875rem;
  }

  /* Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10050 !important;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-overlay.show {
    display: flex !important;
  }

  .modal {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    z-index: 10051 !important;
    margin: auto;
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: #f3f4f6;
    color: #111827;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
  }

  .modal-form-group {
    margin-bottom: 1.25rem;
  }

  .modal-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .modal-input {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
  }

  .modal-input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .modal-checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  .btn-modal {
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1.5px solid;
  }

  .btn-modal-primary {
    background: white;
    color: #3b82f6;
    border-color: #3b82f6;
  }

  .btn-modal-primary:hover {
    background: #3b82f6;
    color: white;
  }

  .btn-modal-danger {
    background: white;
    color: #ef4444;
    border-color: #ef4444;
  }

  .btn-modal-danger:hover {
    background: #ef4444;
    color: white;
  }

  .btn-modal-secondary {
    background: white;
    color: #6b7280;
    border-color: #e5e7eb;
  }

  .btn-modal-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .delete-modal-content {
    text-align: center;
    padding: 1rem 0;
  }

  .delete-modal-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto 1rem;
    background: #fee2e2;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ef4444;
  }

  .delete-modal-text {
    font-size: 1rem;
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .delete-modal-subtext {
    font-size: 0.875rem;
    color: #6b7280;
  }

  /* Toggle Switch Styles */
  .role-toggle-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .role-toggle-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    border-radius: 0.625rem;
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.5);
  }

  .role-toggle-item:hover {
    background: rgba(59, 130, 246, 0.05);
  }

  .role-toggle-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
    letter-spacing: 0.01em;
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 3.25rem;
    height: 1.75rem;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 2rem;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 1.375rem;
    width: 1.375rem;
    left: 0.1875rem;
    bottom: 0.1875rem;
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .toggle-switch input:checked + .toggle-slider {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(1.5rem);
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4), 0 1px 3px rgba(59, 130, 246, 0.3);
  }

  .toggle-switch input:disabled + .toggle-slider {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f3f4f6;
  }

  .toggle-switch input:focus + .toggle-slider {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  .toggle-switch:hover .toggle-slider:not(.disabled) {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  /* Role Popover Styles - Modern Design */
  .account-role-selector {
    display: none;
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: none;
    border-radius: 1rem;
    box-shadow: 
      0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04),
      0 0 0 1px rgba(0, 0, 0, 0.05);
    padding: 1rem 1.25rem;
    z-index: 1000;
    min-width: 200px;
    max-width: 220px;
    animation: fadeInScale 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: auto;
    backdrop-filter: blur(10px);
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-0.5rem) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0) scale(1);
    }
  }

  .account-card:hover .account-role-selector,
  .account-role-selector:hover {
    display: block;
  }

  /* Keep popover visible when hovering over it or the card */
  .account-card:hover .account-role-selector,
  .account-card .account-role-selector:hover {
    display: block !important;
  }

  .role-popover-arrow {
    position: absolute;
    top: -0.5rem;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    width: 1rem;
    height: 1rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: none;
    box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.05);
  }

  @media (max-width: 768px) {
    .accounts-grid {
      grid-template-columns: 1fr;
    }

    .search-filter-bar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search-filter-left {
      flex-direction: column;
      width: 100%;
    }
    
    .search-filter-right {
      width: 100%;
      justify-content: center;
      margin-top: 0.5rem;
    }

    .search-input {
      width: 100%;
      max-width: 100%;
    }
    
    .sort-select {
      width: 100%;
      min-width: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="list-accounts-page">
  <div class="list-accounts-container">
    <div class="page-header">
      <h1 class="page-title">All Accounts</h1>
      
      <form method="get" action="{% url 'app:list_accounts' %}" id="filterForm" class="search-filter-bar">
        <div class="search-filter-left">
          <input 
            type="text" 
            name="search" 
            id="searchInput"
            value="{{ current_search }}" 
            placeholder="Search by name or email..." 
            class="search-input"
            autocomplete="off"
          >
          <select name="role" class="sort-select" onchange="document.getElementById('filterForm').submit();">
            <option value="">All Roles</option>
            <option value="admin" {% if current_role == 'admin' %}selected{% endif %}>Admin</option>
            <option value="staff" {% if current_role == 'staff' %}selected{% endif %}>Staff</option>
            <option value="user" {% if current_role == 'user' %}selected{% endif %}>User</option>
          </select>
          <select name="sort" class="sort-select" onchange="document.getElementById('filterForm').submit();">
            <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>Most Recent</option>
            <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
            <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
          </select>
          {% if current_search or current_role %}
          <a href="{% url 'app:list_accounts' %}" style="padding: 0.625rem 1.5rem; background: white; color: #6b7280; border: 1.5px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; text-decoration: none; transition: all 0.2s ease;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
            Clear
          </a>
          {% endif %}
        </div>
        <div class="search-filter-right">
          <div class="results-count-inline">
            <span>Showing</span>
            <span class="results-count-number">{{ total_records }}</span>
            <span>
              {% if has_filters %}
                result{{ total_records|pluralize }}
                {% if total_records != total_all_users %}
                  of {{ total_all_users }}
                {% endif %}
              {% else %}
                account{{ total_records|pluralize }}
              {% endif %}
            </span>
          </div>
        </div>
      </form>
    </div>

    {% if users %}
    <div class="accounts-grid">
      {% for user in users %}
      <div class="account-card">
        <div class="account-card-header">
          <div class="account-avatar">
            {% if user.profile.profile_photo %}
              <img src="{{ user.profile.profile_photo.url }}" alt="{{ user.get_full_name|default:user.username }}">
            {% else %}
              {{ user.first_name|first|default:user.username|first|upper }}{{ user.last_name|first|default:""|upper }}
            {% endif %}
          </div>
          <div class="account-info">
            <p class="account-name">{{ user.get_full_name|default:user.username }}</p>
            <p class="account-email">{{ user.email|default:"No email" }}</p>
          </div>
        </div>
        {% if request.user.is_superuser or request.user.is_staff %}
        <div class="account-role-selector">
          <div class="role-popover-arrow"></div>
          <div class="role-toggle-container">
            <div class="role-toggle-item">
              <label class="role-toggle-label" for="admin-toggle-{{ user.id }}">Admin</label>
              <label class="toggle-switch">
                <input type="checkbox" 
                       id="admin-toggle-{{ user.id }}" 
                       data-role="admin" 
                       data-user-id="{{ user.id }}"
                       {% if user.is_superuser %}checked{% endif %}
                       {% if not request.user.is_superuser %}disabled{% endif %}
                       onmousedown="event.preventDefault(); handleRoleToggleClick({{ user.id }}, 'admin', this, event)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="role-toggle-item">
              <label class="role-toggle-label" for="staff-toggle-{{ user.id }}">Staff</label>
              <label class="toggle-switch">
                <input type="checkbox" 
                       id="staff-toggle-{{ user.id }}" 
                       data-role="staff" 
                       data-user-id="{{ user.id }}"
                       {% if user.is_staff and not user.is_superuser %}checked{% endif %}
                       onmousedown="event.preventDefault(); handleRoleToggleClick({{ user.id }}, 'staff', this, event)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="role-toggle-item">
              <label class="role-toggle-label" for="user-toggle-{{ user.id }}">User</label>
              <label class="toggle-switch">
                <input type="checkbox" 
                       id="user-toggle-{{ user.id }}" 
                       data-role="user" 
                       data-user-id="{{ user.id }}"
                       {% if not user.is_superuser and not user.is_staff %}checked{% endif %}
                       onmousedown="event.preventDefault(); handleRoleToggleClick({{ user.id }}, 'user', this, event)">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
        {% endif %}
        <div class="account-actions">
          <a href="{% url 'app:view_account' user.id %}" class="view-btn" style="flex: 1;">
            <i data-lucide="eye" style="width: 1rem; height: 1rem;"></i>
            View
          </a>
          {% if request.user.is_superuser or request.user.is_staff %}
          <button onclick="openEditModal({{ user.id }})" class="view-btn" style="flex: 1; border-color: #3b82f6; color: #3b82f6; background: white; cursor: pointer; font-family: inherit; font-size: inherit;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#3b82f6';">
            <i data-lucide="pencil" style="width: 1rem; height: 1rem;"></i>
            Edit
          </button>
          <button onclick="openDeleteModal({{ user.id }}, '{{ user.get_full_name|default:user.username }}')" class="view-btn" style="flex: 1; border-color: #ef4444; color: #ef4444; background: white; cursor: pointer; font-family: inherit; font-size: inherit;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#ef4444';">
            <i data-lucide="trash-2" style="width: 1rem; height: 1rem;"></i>
            Delete
          </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    {% if page_obj.has_other_pages or page_obj.paginator.count > 0 %}
    <div class="pagination-container">
      <div class="pagination-info">
        <span>Records: {{ start_record }} of {{ total_records }}</span>
        <div class="pagination-info-separator"></div>
        <div class="pagination-page-select">
          <span>Page :</span>
          <select class="page-input" onchange="goToPage(this.value)">
            {% for page_num in page_obj.paginator.page_range %}
              <option value="{{ page_num }}" {% if page_num == page_obj.number %}selected{% endif %}>{{ page_num }}</option>
            {% endfor %}
          </select>
          <span>of {{ page_obj.paginator.num_pages }}</span>
        </div>
      </div>
      
      <div class="pagination-nav">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}" class="pagination-btn arrow">
            <i data-lucide="chevron-left" style="width: 1rem; height: 1rem;"></i>
          </a>
        {% endif %}
        
        {% for page_num in page_obj.paginator.page_range %}
          {% if page_num == page_obj.number %}
            <span class="pagination-btn active">{{ page_num }}</span>
          {% elif page_num <= 5 %}
            <a href="?page={{ page_num }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}" class="pagination-btn">{{ page_num }}</a>
          {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}" class="pagination-btn arrow">
            <i data-lucide="chevron-right" style="width: 1rem; height: 1rem;"></i>
          </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% else %}
    <div class="no-results">
      <p>No accounts found.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Edit Account</h2>
      <button class="modal-close" onclick="closeEditModal()">
        <i data-lucide="x" style="width: 1.25rem; height: 1.25rem;"></i>
      </button>
    </div>
    <form id="editForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-body">
        <div class="modal-form-group">
          <label class="modal-label">Username</label>
          <input type="text" name="username" id="edit_username" class="modal-input" required>
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Email</label>
          <input type="email" name="email" id="edit_email" class="modal-input" required>
        </div>
        <div class="modal-form-group">
          <label class="modal-label">First Name</label>
          <input type="text" name="first_name" id="edit_first_name" class="modal-input">
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Last Name</label>
          <input type="text" name="last_name" id="edit_last_name" class="modal-input">
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Phone</label>
          <input type="text" name="phone" id="edit_phone" class="modal-input">
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Country</label>
          <input type="text" name="country" id="edit_country" class="modal-input">
        </div>
        {% if request.user.is_superuser %}
        <div class="modal-form-group">
          <label class="modal-label">Role</label>
          <select name="role" id="edit_role" class="modal-input" required>
            <option value="user">User</option>
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        {% else %}
        <input type="hidden" name="role" id="edit_role" value="user">
        {% endif %}
        <div class="modal-form-group">
          <label class="modal-label">Profile Photo</label>
          <input type="file" name="profile_photo" id="edit_profile_photo" accept="image/*" class="modal-input">
        </div>
        <div class="modal-form-group">
          <div class="modal-checkbox-group">
            <input type="checkbox" name="is_active" id="edit_is_active" class="modal-checkbox">
            <label class="modal-label" style="margin: 0; cursor: pointer;">Active Account</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-modal btn-modal-primary">
          <i data-lucide="save" style="width: 1rem; height: 1rem;"></i>
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">Delete Account</h2>
      <button class="modal-close" onclick="closeDeleteModal()">
        <i data-lucide="x" style="width: 1.25rem; height: 1.25rem;"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="delete-modal-content">
        <div class="delete-modal-icon">
          <i data-lucide="alert-triangle" style="width: 2rem; height: 2rem;"></i>
        </div>
        <p class="delete-modal-text">Are you sure you want to delete this account?</p>
        <p class="delete-modal-subtext" id="deleteUserName"></p>
        <p class="delete-modal-subtext" style="margin-top: 0.5rem; color: #ef4444;">This action cannot be undone.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-modal btn-modal-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button type="button" class="btn-modal btn-modal-danger" onclick="confirmDelete()">
        <i data-lucide="trash-2" style="width: 1rem; height: 1rem;"></i>
        Delete
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  let currentEditUserId = null;
  let currentDeleteUserId = null;

  // Close modals when clicking outside
  document.addEventListener('DOMContentLoaded', function() {
    const editModal = document.getElementById('editModal');
    const deleteModal = document.getElementById('deleteModal');
    
    if (editModal) {
      editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
          closeEditModal();
        }
      });
    }
    
    if (deleteModal) {
      deleteModal.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
          closeDeleteModal();
        }
      });
    }
    
    // Ensure role toggles are in correct state on page load
    // Fix any inconsistencies - superusers should always show Admin checked
    {% for user in users %}
    (function() {
      const adminToggle = document.getElementById('admin-toggle-{{ user.id }}');
      const staffToggle = document.getElementById('staff-toggle-{{ user.id }}');
      const userToggle = document.getElementById('user-toggle-{{ user.id }}');
      
      if (!adminToggle || !staffToggle || !userToggle) return;
      
      // If user is superuser according to backend, ensure Admin is checked
      {% if user.is_superuser %}
      adminToggle.checked = true;
      staffToggle.checked = false;
      userToggle.checked = false;
      {% else %}
      // For non-superusers, ensure only one toggle is checked
      // Priority: Admin > Staff > User
      if (adminToggle.checked) {
        staffToggle.checked = false;
        userToggle.checked = false;
      } else if (staffToggle.checked) {
        adminToggle.checked = false;
        userToggle.checked = false;
      } else if (userToggle.checked) {
        adminToggle.checked = false;
        staffToggle.checked = false;
      } else {
        // If none are checked, default to User
        userToggle.checked = true;
      }
      {% endif %}
    })();
    {% endfor %}
  });

  function openEditModal(userId) {
    currentEditUserId = userId;
    const modal = document.getElementById('editModal');
    if (!modal) {
      console.error('Edit modal not found');
      return;
    }
    // Force display and ensure visibility
    modal.style.display = 'flex';
    modal.classList.add('show');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
    
    // Fetch user data
    const url = `{% url 'app:get_user_data' 0 %}`.replace('0', userId.toString());
    fetch(url, {
      method: 'GET',
      credentials: 'same-origin',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    })
      .then(response => {
        if (!response.ok) {
          // Try to get error message from response
          return response.json().then(data => {
            throw new Error(data.error || 'Network response was not ok: ' + response.status);
          }).catch(() => {
            throw new Error('Network response was not ok: ' + response.status);
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          document.getElementById('edit_username').value = data.user.username || '';
          document.getElementById('edit_email').value = data.user.email || '';
          document.getElementById('edit_first_name').value = data.user.first_name || '';
          document.getElementById('edit_last_name').value = data.user.last_name || '';
          document.getElementById('edit_phone').value = data.profile.phone || '';
          document.getElementById('edit_country').value = data.profile.country || '';
          const roleField = document.getElementById('edit_role');
          if (roleField) {
            roleField.value = data.user.role || 'user';
          }
          document.getElementById('edit_is_active').checked = data.user.is_active || false;
        } else {
          alert('Error loading user data: ' + (data.error || 'Unknown error'));
          closeEditModal();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading user data: ' + error.message);
        closeEditModal();
      });
    
    lucide.createIcons();
  }

  function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
      modal.classList.remove('show');
      modal.style.display = 'none';
    }
    document.body.style.overflow = ''; // Restore scrolling
    currentEditUserId = null;
    const form = document.getElementById('editForm');
    if (form) {
      form.reset();
    }
  }

  function openDeleteModal(userId, userName) {
    currentDeleteUserId = userId;
    const modal = document.getElementById('deleteModal');
    const userNameElement = document.getElementById('deleteUserName');
    
    if (!modal) {
      console.error('Delete modal not found');
      return;
    }
    
    if (userNameElement) {
      userNameElement.textContent = userName;
    }
    
    // Force display and ensure visibility
    modal.style.display = 'flex';
    modal.classList.add('show');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
    lucide.createIcons();
  }

  function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) {
      modal.classList.remove('show');
      modal.style.display = 'none';
    }
    document.body.style.overflow = ''; // Restore scrolling
    currentDeleteUserId = null;
  }

  function confirmDelete() {
    if (!currentDeleteUserId) return;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    const deleteUrl = `{% url 'app:delete_user_account' 0 %}`.replace('0', currentDeleteUserId.toString());
    
    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Error deleting account: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting account. Please try again.');
    });
  }

  // Handle edit form submission
  document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentEditUserId) return;
    
    const formData = new FormData(this);
    const csrfToken = formData.get('csrfmiddlewaretoken');
    
    fetch(`/edit_user_account/${currentEditUserId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeEditModal();
        location.reload();
      } else {
        alert('Error updating account: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating account. Please try again.');
    });
  });

  // Duplicate event listeners removed - already handled in DOMContentLoaded above

  function goToPage(pageNum) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', pageNum);
    window.location.href = url.toString();
  }

  function handleRoleToggleClick(userId, roleType, toggleElement, event) {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }
    
    // Get all toggles for this user
    const adminToggle = document.getElementById(`admin-toggle-${userId}`);
    const staffToggle = document.getElementById(`staff-toggle-${userId}`);
    const userToggle = document.getElementById(`user-toggle-${userId}`);
    
    // Get current state BEFORE any changes (since we prevented default, state hasn't changed yet)
    const currentlyChecked = toggleElement.checked;
    
    // Count how many toggles are currently checked
    const checkedCount = [
      adminToggle?.checked,
      staffToggle?.checked,
      userToggle?.checked
    ].filter(Boolean).length;
    
    // If this toggle is already checked and it's the only one, prevent turning it off
    if (currentlyChecked && checkedCount === 1) {
      // This is the only active role, don't allow turning it off
      toggleElement.checked = true; // Keep it checked
      return;
    }
    
    // If clicking on an unchecked toggle, switch to it
    if (!currentlyChecked) {
      // Turn off all other toggles
      if (adminToggle && roleType !== 'admin') adminToggle.checked = false;
      if (staffToggle && roleType !== 'staff') staffToggle.checked = false;
      if (userToggle && roleType !== 'user') userToggle.checked = false;
      
      // Turn on the clicked toggle
      toggleElement.checked = true;
      
      // Update database with the new role
      updateRoleInDatabase(userId, roleType, toggleElement);
    } else {
      // Clicking on an already checked toggle when there are multiple checked
      // This shouldn't normally happen, but if it does, keep it checked
      toggleElement.checked = true;
    }
  }

  function updateRoleInDatabase(userId, roleType, toggleElement) {
    // Get all toggles for this user
    const adminToggle = document.getElementById(`admin-toggle-${userId}`);
    const staffToggle = document.getElementById(`staff-toggle-${userId}`);
    const userToggle = document.getElementById(`user-toggle-${userId}`);
    
    // Disable all toggles while processing
    if (adminToggle) adminToggle.disabled = true;
    if (staffToggle) staffToggle.disabled = true;
    if (userToggle) userToggle.disabled = true;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    const roleUrl = `{% url 'app:update_user_role' 0 %}`.replace('0', userId.toString());
    
    // Update role in database
    console.log('Updating role for user', userId, 'to', roleType);
    fetch(roleUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        role_type: roleType
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        console.log('Role updated successfully in database');
        // Success - show visual feedback
        const slider = toggleElement.nextElementSibling;
        if (slider) {
          const originalBg = slider.style.backgroundColor;
          slider.style.backgroundColor = '#22c55e';
          setTimeout(() => {
            slider.style.backgroundColor = originalBg || '';
          }, 1000);
        }
      } else {
        console.error('Error updating role:', data.error);
        alert('Error updating role: ' + (data.error || 'Unknown error'));
        // Reload to get correct state from database
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error updating role:', error);
      alert('Error updating role. Please try again.');
      // Reload to get correct state from database
      location.reload();
    })
    .finally(() => {
      // Re-enable all toggles
      if (adminToggle) adminToggle.disabled = false;
      if (staffToggle) staffToggle.disabled = false;
      if (userToggle) userToggle.disabled = false;
    });
  }

  // Legacy function for backward compatibility
  function handleRoleToggle(userId, roleType, toggleElement) {
    handleRoleToggleClick(userId, roleType, toggleElement, { preventDefault: () => {} });
  }

  // Role popover hover management
  let rolePopoverTimeout = null;

  function clearRolePopoverTimeout(popover) {
    if (rolePopoverTimeout) {
      clearTimeout(rolePopoverTimeout);
      rolePopoverTimeout = null;
    }
  }

  function hideRolePopoverDelayed(popover) {
    clearRolePopoverTimeout(popover);
    rolePopoverTimeout = setTimeout(() => {
      if (popover) {
        popover.style.display = 'none';
      }
    }, 300); // 300ms delay before hiding
  }

  // Keep popover visible when hovering over account card
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-search functionality
    let searchTimeout = null;
    const searchInput = document.getElementById('searchInput');
    const filterForm = document.getElementById('filterForm');
    
    if (searchInput && filterForm) {
      searchInput.addEventListener('input', function(e) {
        // Clear previous timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // Set new timeout to submit form after user stops typing (500ms delay)
        searchTimeout = setTimeout(function() {
          filterForm.submit();
        }, 500);
      });
      
      // Also submit on Enter key
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }
          filterForm.submit();
        }
      });
    }
    const accountCards = document.querySelectorAll('.account-card');
    accountCards.forEach(card => {
      const popover = card.querySelector('.account-role-selector');
      if (!popover) return;

      let cardTimeout = null;
      let popoverTimeout = null;

      card.addEventListener('mouseenter', function() {
        clearTimeout(cardTimeout);
        clearTimeout(popoverTimeout);
        popover.style.display = 'block';
      });

      card.addEventListener('mouseleave', function(e) {
        // Check if mouse is moving to popover
        const relatedTarget = e.relatedTarget;
        if (popover.contains(relatedTarget)) {
          return; // Don't hide if moving to popover
        }
        cardTimeout = setTimeout(() => {
          popover.style.display = 'none';
        }, 200);
      });

      popover.addEventListener('mouseenter', function() {
        clearTimeout(cardTimeout);
        clearTimeout(popoverTimeout);
        popover.style.display = 'block';
      });

      popover.addEventListener('mouseleave', function() {
        popoverTimeout = setTimeout(() => {
          popover.style.display = 'none';
        }, 200);
      });
    });
  });

  // Legacy function for backward compatibility (if needed elsewhere)
  function changeUserRole(userId, newRole, selectElement) {
    // Map to toggle-based approach
    const toggleId = `${newRole}-toggle-${userId}`;
    const toggle = document.getElementById(toggleId);
    if (toggle) {
      toggle.checked = true;
      handleRoleToggle(userId, newRole, toggle);
    }
  }
</script>
{% csrf_token %}
{% endblock %}

