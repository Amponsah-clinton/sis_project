{% extends 'app/base.html' %}
{% load static %}

{% block title %}List Accounts - ScholarIndex{% endblock %}

{% block extra_css %}
<style>
  .list-accounts-page {
    min-height: calc(100vh - 5rem);
    background-color: #f9fafb;
    padding: 2rem 1rem;
  }

  .list-accounts-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .page-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 1rem 0;
  }

  .search-filter-bar {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 0.625rem 1rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .sort-select {
    padding: 0.625rem 1rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .sort-select:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .accounts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .account-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
  }

  .account-card:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  .account-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .account-avatar {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
  }

  .account-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .account-info {
    flex: 1;
    min-width: 0;
  }

  .account-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    margin: 0 0 0.25rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .account-email {
    font-size: 0.75rem;
    color: #6b7280;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .account-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #f3f4f6;
  }

  .view-btn {
    flex: 1;
    padding: 0.5rem 1rem;
    background: white;
    color: #3b82f6;
    border: 1.5px solid #3b82f6;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    text-align: center;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .view-btn:hover {
    background: #3b82f6;
    color: white;
  }

  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding: 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
  }

  .pagination-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #f97316;
    font-size: 0.875rem;
  }

  .pagination-info-separator {
    width: 1px;
    height: 1.5rem;
    background: #e5e7eb;
  }

  .pagination-page-select {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #f97316;
    font-size: 0.875rem;
  }

  .page-input {
    width: 3rem;
    padding: 0.375rem 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    text-align: center;
    appearance: none;
    background: white;
    cursor: pointer;
  }

  .pagination-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .pagination-btn {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    background: white;
    color: #111827;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .pagination-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .pagination-btn.active {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  .pagination-btn.arrow {
    color: #111827;
  }

  .no-results {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }

  /* Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: #f3f4f6;
    color: #111827;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
  }

  .modal-form-group {
    margin-bottom: 1.25rem;
  }

  .modal-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .modal-input {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1.5px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
  }

  .modal-input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .modal-checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  .btn-modal {
    padding: 0.625rem 1.25rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1.5px solid;
  }

  .btn-modal-primary {
    background: white;
    color: #3b82f6;
    border-color: #3b82f6;
  }

  .btn-modal-primary:hover {
    background: #3b82f6;
    color: white;
  }

  .btn-modal-danger {
    background: white;
    color: #ef4444;
    border-color: #ef4444;
  }

  .btn-modal-danger:hover {
    background: #ef4444;
    color: white;
  }

  .btn-modal-secondary {
    background: white;
    color: #6b7280;
    border-color: #e5e7eb;
  }

  .btn-modal-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .delete-modal-content {
    text-align: center;
    padding: 1rem 0;
  }

  .delete-modal-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto 1rem;
    background: #fee2e2;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ef4444;
  }

  .delete-modal-text {
    font-size: 1rem;
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .delete-modal-subtext {
    font-size: 0.875rem;
    color: #6b7280;
  }

  @media (max-width: 768px) {
    .accounts-grid {
      grid-template-columns: 1fr;
    }

    .search-filter-bar {
      flex-direction: column;
    }

    .search-input,
    .sort-select {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="list-accounts-page">
  <div class="list-accounts-container">
    <div class="page-header">
      <h1 class="page-title">All Accounts</h1>
      
      <form method="get" action="{% url 'app:list_accounts' %}" id="filterForm" class="search-filter-bar">
        <input 
          type="text" 
          name="search" 
          value="{{ current_search }}" 
          placeholder="Search by name or email..." 
          class="search-input"
        >
        <select name="role" class="sort-select" onchange="document.getElementById('filterForm').submit();">
          <option value="">All Roles</option>
          <option value="admin" {% if current_role == 'admin' %}selected{% endif %}>Admin</option>
          <option value="staff" {% if current_role == 'staff' %}selected{% endif %}>Staff</option>
          <option value="user" {% if current_role == 'user' %}selected{% endif %}>User</option>
        </select>
        <select name="sort" class="sort-select" onchange="document.getElementById('filterForm').submit();">
          <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>Most Recent</option>
          <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
          <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
        </select>
        <button type="submit" style="padding: 0.625rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background 0.2s ease;" onmouseover="this.style.background='#2563eb';" onmouseout="this.style.background='#3b82f6';">
          Search
        </button>
        {% if current_search or current_role %}
        <a href="{% url 'app:list_accounts' %}" style="padding: 0.625rem 1.5rem; background: white; color: #6b7280; border: 1.5px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; text-decoration: none; transition: all 0.2s ease;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='white';">
          Clear
        </a>
        {% endif %}
      </form>
    </div>

    {% if users %}
    <div class="accounts-grid">
      {% for user in users %}
      <div class="account-card">
        <div class="account-card-header">
          <div class="account-avatar">
            {% if user.profile.profile_photo %}
              <img src="{{ user.profile.profile_photo.url }}" alt="{{ user.get_full_name|default:user.username }}">
            {% else %}
              {{ user.first_name|first|default:user.username|first|upper }}{{ user.last_name|first|default:""|upper }}
            {% endif %}
          </div>
          <div class="account-info">
            <p class="account-name">{{ user.get_full_name|default:user.username }}</p>
            <p class="account-email">{{ user.email|default:"No email" }}</p>
          </div>
        </div>
        {% if request.user.is_superuser %}
        <div class="account-role-selector" style="margin-bottom: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">User Role</label>
          <select class="role-select" id="role-select-{{ user.id }}" data-user-id="{{ user.id }}" data-current-role="{% if user.is_superuser %}admin{% elif user.is_staff %}staff{% else %}user{% endif %}" onchange="changeUserRole({{ user.id }}, this.value, this)" style="width: 100%; padding: 0.5rem 0.75rem; border: 1.5px solid #e5e7eb; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; background: white; cursor: pointer; transition: all 0.2s ease;">
            <option value="user" {% if not user.is_superuser and not user.is_staff %}selected{% endif %}>User</option>
            <option value="staff" {% if user.is_staff and not user.is_superuser %}selected{% endif %}>Staff</option>
            <option value="admin" {% if user.is_superuser %}selected{% endif %}>Admin</option>
          </select>
        </div>
        {% else %}
        <div style="margin-bottom: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
          <span style="font-size: 0.75rem; font-weight: 600; color: #374151; margin-right: 0.5rem;">Role:</span>
          <span style="font-size: 0.75rem; color: #6b7280; text-transform: capitalize;">
            {% if user.is_superuser %}Admin{% elif user.is_staff %}Staff{% else %}User{% endif %}
          </span>
        </div>
        {% endif %}
        <div class="account-actions">
          <a href="{% url 'app:view_account' user.id %}" class="view-btn" style="flex: 1;">
            <i data-lucide="eye" style="width: 1rem; height: 1rem;"></i>
            View
          </a>
          <button onclick="openEditModal({{ user.id }})" class="view-btn" style="flex: 1; border-color: #3b82f6; color: #3b82f6; background: white; cursor: pointer; font-family: inherit; font-size: inherit;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#3b82f6';">
            <i data-lucide="pencil" style="width: 1rem; height: 1rem;"></i>
            Edit
          </button>
          <button onclick="openDeleteModal({{ user.id }}, '{{ user.get_full_name|default:user.username }}')" class="view-btn" style="flex: 1; border-color: #ef4444; color: #ef4444; background: white; cursor: pointer; font-family: inherit; font-size: inherit;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#ef4444';">
            <i data-lucide="trash-2" style="width: 1rem; height: 1rem;"></i>
            Delete
          </button>
        </div>
      </div>
      {% endfor %}
    </div>

    {% if page_obj.has_other_pages or page_obj.paginator.count > 0 %}
    <div class="pagination-container">
      <div class="pagination-info">
        <span>Records: {{ start_record }} of {{ total_records }}</span>
        <div class="pagination-info-separator"></div>
        <div class="pagination-page-select">
          <span>Page :</span>
          <select class="page-input" onchange="goToPage(this.value)">
            {% for page_num in page_obj.paginator.page_range %}
              <option value="{{ page_num }}" {% if page_num == page_obj.number %}selected{% endif %}>{{ page_num }}</option>
            {% endfor %}
          </select>
          <span>of {{ page_obj.paginator.num_pages }}</span>
        </div>
      </div>
      
      <div class="pagination-nav">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}" class="pagination-btn arrow">
            <i data-lucide="chevron-left" style="width: 1rem; height: 1rem;"></i>
          </a>
        {% endif %}
        
        {% for page_num in page_obj.paginator.page_range %}
          {% if page_num == page_obj.number %}
            <span class="pagination-btn active">{{ page_num }}</span>
          {% elif page_num <= 5 %}
            <a href="?page={{ page_num }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}" class="pagination-btn">{{ page_num }}</a>
          {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_role %}&role={{ current_role }}{% endif %}" class="pagination-btn arrow">
            <i data-lucide="chevron-right" style="width: 1rem; height: 1rem;"></i>
          </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% else %}
    <div class="no-results">
      <p>No accounts found.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Edit Account</h2>
      <button class="modal-close" onclick="closeEditModal()">
        <i data-lucide="x" style="width: 1.25rem; height: 1.25rem;"></i>
      </button>
    </div>
    <form id="editForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-body">
        <div class="modal-form-group">
          <label class="modal-label">Username</label>
          <input type="text" name="username" id="edit_username" class="modal-input" required>
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Email</label>
          <input type="email" name="email" id="edit_email" class="modal-input" required>
        </div>
        <div class="modal-form-group">
          <label class="modal-label">First Name</label>
          <input type="text" name="first_name" id="edit_first_name" class="modal-input">
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Last Name</label>
          <input type="text" name="last_name" id="edit_last_name" class="modal-input">
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Phone</label>
          <input type="text" name="phone" id="edit_phone" class="modal-input">
        </div>
        <div class="modal-form-group">
          <label class="modal-label">Country</label>
          <input type="text" name="country" id="edit_country" class="modal-input">
        </div>
        {% if request.user.is_superuser %}
        <div class="modal-form-group">
          <label class="modal-label">Role</label>
          <select name="role" id="edit_role" class="modal-input" required>
            <option value="user">User</option>
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        {% else %}
        <input type="hidden" name="role" id="edit_role" value="user">
        {% endif %}
        <div class="modal-form-group">
          <label class="modal-label">Profile Photo</label>
          <input type="file" name="profile_photo" id="edit_profile_photo" accept="image/*" class="modal-input">
        </div>
        <div class="modal-form-group">
          <div class="modal-checkbox-group">
            <input type="checkbox" name="is_active" id="edit_is_active" class="modal-checkbox">
            <label class="modal-label" style="margin: 0; cursor: pointer;">Active Account</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-modal btn-modal-primary">
          <i data-lucide="save" style="width: 1rem; height: 1rem;"></i>
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">Delete Account</h2>
      <button class="modal-close" onclick="closeDeleteModal()">
        <i data-lucide="x" style="width: 1.25rem; height: 1.25rem;"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="delete-modal-content">
        <div class="delete-modal-icon">
          <i data-lucide="alert-triangle" style="width: 2rem; height: 2rem;"></i>
        </div>
        <p class="delete-modal-text">Are you sure you want to delete this account?</p>
        <p class="delete-modal-subtext" id="deleteUserName"></p>
        <p class="delete-modal-subtext" style="margin-top: 0.5rem; color: #ef4444;">This action cannot be undone.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-modal btn-modal-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button type="button" class="btn-modal btn-modal-danger" onclick="confirmDelete()">
        <i data-lucide="trash-2" style="width: 1rem; height: 1rem;"></i>
        Delete
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }

  let currentEditUserId = null;
  let currentDeleteUserId = null;

  function openEditModal(userId) {
    currentEditUserId = userId;
    const modal = document.getElementById('editModal');
    modal.classList.add('show');
    
    // Fetch user data
    const url = `{% url 'app:get_user_data' 0 %}`.replace('0', userId.toString());
    fetch(url, {
      method: 'GET',
      credentials: 'same-origin',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    })
      .then(response => {
        if (!response.ok) {
          // Try to get error message from response
          return response.json().then(data => {
            throw new Error(data.error || 'Network response was not ok: ' + response.status);
          }).catch(() => {
            throw new Error('Network response was not ok: ' + response.status);
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          document.getElementById('edit_username').value = data.user.username || '';
          document.getElementById('edit_email').value = data.user.email || '';
          document.getElementById('edit_first_name').value = data.user.first_name || '';
          document.getElementById('edit_last_name').value = data.user.last_name || '';
          document.getElementById('edit_phone').value = data.profile.phone || '';
          document.getElementById('edit_country').value = data.profile.country || '';
          const roleField = document.getElementById('edit_role');
          if (roleField) {
            roleField.value = data.user.role || 'user';
          }
          document.getElementById('edit_is_active').checked = data.user.is_active || false;
        } else {
          alert('Error loading user data: ' + (data.error || 'Unknown error'));
          closeEditModal();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading user data: ' + error.message);
        closeEditModal();
      });
    
    lucide.createIcons();
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    currentEditUserId = null;
    document.getElementById('editForm').reset();
  }

  function openDeleteModal(userId, userName) {
    currentDeleteUserId = userId;
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteModal').classList.add('show');
    lucide.createIcons();
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
    currentDeleteUserId = null;
  }

  function confirmDelete() {
    if (!currentDeleteUserId) return;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    const deleteUrl = `{% url 'app:delete_user_account' 0 %}`.replace('0', currentDeleteUserId.toString());
    
    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Error deleting account: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting account. Please try again.');
    });
  }

  // Handle edit form submission
  document.getElementById('editForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentEditUserId) return;
    
    const formData = new FormData(this);
    const csrfToken = formData.get('csrfmiddlewaretoken');
    
    fetch(`/edit_user_account/${currentEditUserId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeEditModal();
        location.reload();
      } else {
        alert('Error updating account: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating account. Please try again.');
    });
  });

  // Close modals when clicking outside
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  });

  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDeleteModal();
    }
  });

  function goToPage(pageNum) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', pageNum);
    window.location.href = url.toString();
  }

  function changeUserRole(userId, newRole, selectElement) {
    const select = selectElement || document.getElementById(`role-select-${userId}`);
    const previousValue = select ? select.getAttribute('data-current-role') : null;
    
    if (!confirm(`Are you sure you want to change this user's role to ${newRole.toUpperCase()}?`)) {
      // Reset dropdown to previous value
      if (select && previousValue) {
        select.value = previousValue;
      }
      return;
    }
    
    // Disable while processing
    if (select) {
      select.disabled = true;
      select.style.opacity = '0.6';
      select.style.cursor = 'wait';
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    const roleUrl = `{% url 'app:update_user_role' 0 %}`.replace('0', userId.toString());
    
    // Update role based on selection
    let roleType = 'user';
    if (newRole === 'admin') {
      roleType = 'admin';
    } else if (newRole === 'staff') {
      roleType = 'staff';
    } else {
      roleType = 'user';
    }
    
    fetch(roleUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        role_type: roleType
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update the current role attribute
        if (select) {
          select.setAttribute('data-current-role', newRole);
          select.style.borderColor = '#22c55e';
          select.style.backgroundColor = '#f0fdf4';
          select.disabled = false;
          select.style.opacity = '1';
          select.style.cursor = 'pointer';
          setTimeout(() => {
            select.style.borderColor = '#e5e7eb';
            select.style.backgroundColor = 'white';
          }, 2000);
        }
      } else {
        alert('Error updating role: ' + (data.error || 'Unknown error'));
        // Reset dropdown to previous value
        if (select && previousValue) {
          select.value = previousValue;
          select.disabled = false;
          select.style.opacity = '1';
          select.style.cursor = 'pointer';
        } else {
          location.reload();
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error updating role. Please try again.');
      // Reset dropdown to previous value
      if (select && previousValue) {
        select.value = previousValue;
        select.disabled = false;
        select.style.opacity = '1';
        select.style.cursor = 'pointer';
      } else {
        location.reload();
      }
    });
  }
</script>
{% csrf_token %}
{% endblock %}

